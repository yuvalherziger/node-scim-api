services:
  mongo:
    image: mongo:8.0
    container_name: scim-mongo
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' | grep 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    volumes:
      - scim-mongo-data:/data/db

  api:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: node-scim-api
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped
    environment:
      # For local testing. Change these by editing this file (or a copy of it).
      SCIM_BEARER_TOKEN: "change-me"
      SCIM_SERVER_PORT: "3999"
      LOG_LEVEL: "info"
      DB_NAME: "scim"
      SCIM_BASE_URL: "http://localhost:3999"
      MONGODB_URI: "mongodb://mongo:27017/?directConnection=true"
    ports:
      - "3999:3999"

volumes:
  scim-mongo-data:
    driver: local
